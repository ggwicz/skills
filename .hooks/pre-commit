#!/bin/sh
# Pre-commit hook: validate all skills in the monorepo.
# Activated via: git config core.hooksPath .hooks

set -e

echo "Validating skills..."

errors=0

# Find all skill directories (any directory containing a SKILL.md)
for skill_dir in */; do
  skill_file="${skill_dir}SKILL.md"
  [ -f "$skill_file" ] || continue

  skill_name=$(basename "$skill_dir")
  echo "  Checking $skill_name..."

  # 1. SKILL.md must have a name field in frontmatter
  if ! head -20 "$skill_file" | grep -q "^name:"; then
    echo "    ERROR: $skill_file missing 'name:' in frontmatter"
    errors=$((errors + 1))
  fi

  # 2. name field must match directory name
  declared_name=$(head -20 "$skill_file" | grep "^name:" | sed 's/^name:[[:space:]]*//')
  if [ "$declared_name" != "$skill_name" ]; then
    echo "    ERROR: name '$declared_name' does not match directory '$skill_name'"
    errors=$((errors + 1))
  fi

  # 3. SKILL.md must have a description field
  if ! head -20 "$skill_file" | grep -q "^description:"; then
    echo "    ERROR: $skill_file missing 'description:' in frontmatter"
    errors=$((errors + 1))
  fi

  # 4. Per-skill README must exist
  if [ ! -f "${skill_dir}README.md" ]; then
    echo "    ERROR: ${skill_dir}README.md not found"
    errors=$((errors + 1))
  fi
done

if [ "$errors" -gt 0 ]; then
  echo "Validation failed with $errors error(s)."
  exit 1
fi

echo "All skills valid."

# ShellCheck: lint staged .sh files
if command -v shellcheck >/dev/null 2>&1; then
  staged_sh=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)
  if [ -n "$staged_sh" ]; then
    echo "Running ShellCheck..."
    echo "$staged_sh" | xargs shellcheck || exit 1
    echo "ShellCheck passed."
  fi
else
  echo "  (shellcheck not installed, skipping lint)"
fi

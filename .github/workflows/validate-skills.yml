name: Validate Skills

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint shell scripts
        run: |
          shopt -s globstar nullglob
          files=(**/*.sh)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No .sh files found."
            exit 0
          fi
          echo "Checking ${#files[@]} file(s)..."
          shellcheck "${files[@]}"

  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate skill structure
        run: |
          errors=0

          # Extract YAML frontmatter between --- markers (handles multi-line values)
          get_frontmatter() {
            awk 'NR==1 && /^---$/{found=1; next} found && /^---$/{exit} found{print}' "$1"
          }

          # Extract a top-level YAML key value (single-line only, sufficient for name)
          get_yaml_key() {
            echo "$1" | grep "^$2:" | sed "s/^$2:[[:space:]]*//"
          }

          for skill_dir in */; do
            skill_file="${skill_dir}SKILL.md"
            [ -f "$skill_file" ] || continue

            skill_name=$(basename "$skill_dir")
            echo "Validating $skill_name..."

            frontmatter=$(get_frontmatter "$skill_file")

            # SKILL.md must have name in frontmatter
            if ! echo "$frontmatter" | grep -q "^name:"; then
              echo "::error::$skill_file missing 'name:' in frontmatter"
              errors=$((errors + 1))
            fi

            # name must match directory
            declared_name=$(get_yaml_key "$frontmatter" "name")
            if [ "$declared_name" != "$skill_name" ]; then
              echo "::error::name '$declared_name' does not match directory '$skill_name'"
              errors=$((errors + 1))
            fi

            # SKILL.md must have description
            if ! echo "$frontmatter" | grep -q "^description:"; then
              echo "::error::$skill_file missing 'description:' in frontmatter"
              errors=$((errors + 1))
            fi

            # Per-skill README must exist
            if [ ! -f "${skill_dir}README.md" ]; then
              echo "::error::${skill_dir}README.md not found"
              errors=$((errors + 1))
            fi

            # references/ directory should exist
            if [ ! -d "${skill_dir}references" ]; then
              echo "::warning::${skill_dir}references/ not found"
            fi

            # Run skill tests if they exist
            if [ -f "${skill_dir}tests/run-tests.sh" ]; then
              echo "Running tests for $skill_name..."
              if ! sh "${skill_dir}tests/run-tests.sh"; then
                echo "::error::Tests failed for $skill_name"
                errors=$((errors + 1))
              fi
            fi
          done

          if [ "$errors" -gt 0 ]; then
            echo "Validation failed with $errors error(s)."
            exit 1
          fi

          echo "All skills valid."

      - name: Verify root README lists all skills
        run: |
          errors=0
          for skill_dir in */; do
            [ -f "${skill_dir}SKILL.md" ] || continue
            skill_name=$(basename "$skill_dir")
            if ! grep -q "$skill_name" README.md; then
              echo "::error::Skill '$skill_name' not listed in root README.md"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            exit 1
          fi
          echo "All skills listed in README."
